# QAOps, или почему тестировщик должен построить CI/CD.
[Описать ужасы написания тестов и бытия тестировщиком]
Всем привет меня зовут Дима и я тестировщик. Писать тесты я начал 12 лет назад, сначала Unit тесты, потом 
performance, e2e, и т.д. Почти все время я оправдывал свое желание писать тесты заботой о качестве продукта.
Эта схема работала: больше тестов -> меньше багов -> качественней продукт!

Все было прекрасно, я менял компании писал тесты, тестовые фреймворки, настраивал Jenkins
пока в один прекрасный момент не пришел в DINS.

    [о компании?]
    
    Мы разрабатываем облачную систему комуникации, звонки видеоконференции командный мессенджер контакт центр,
    Мы даже умеем отправлять MMS и Факсы!
    И да наша система построенна на принципах SOA
    
    На данный момент у нас более 300 сервисов.
    
    API платформа предоставляет возможность нашим внутренним и внешним разработчикам а так же другим компаниям интегрироваться с нашей системой.
    На данный момент платформа насчитывает порядка 70 сервисов, которые разрабатывают 60 человек (7 команд).
    
К тому моменты для нашей api платформы было написано 14 000 е2е тестов, 12 000 Unit тестов и у каждой команды было свое 
тестовое окружение + выделенные окружения для непрерывной интеграции.

Для меня тогда это выглядело как сказка, ровно до того момента как меня попросили прогнать регрессию:

Во первых мне нужно было подготовить окружение:

- Найти какие версии сервисов нам нужны
- Проверить правильно ли они настроенны
- Задеплоить их

Во вторых нужно было прогнать саму регрессию:

- Проверить правильные ли версии Jenkins Job у нас используются
- Обновить их
- Подготовить данные для тестов
- Запустить p0 тесты
- Починить окружение
- Перепрогнать p0 тесты
- Запустить основную регрессию
- Заретраить ее до позеленения

Так я быстро понял откуда пошло правило: "Тест который не упал 3 раза не считается упавшим"

А что если в итоге упадет даже 1-2% тестов, разобрать 360 тестов не так то и просто, как следствие регрессия занимает 2-3 дня!
Так же не следует забывать что готовить окружение для регрессии можно неделями!

> О каком качестве можно говорить если мы ретраим?
> О каком качестве можно говорить если регрессия никогда не бывает зеленой?
> Как добавление еще нескольких тысяч тестов повысит качество?

> Почему я ненавидел запускать регрессию?

Не для того я пришел в тестирование чтоб неделями настраивать регрессионное и командное окружения!
Не для того я пришел в тестирование чтоб ретраить упавшие тесты! 
Не для того я пришел в тестирование чтоб ждать пока освободится регрессионное окружение!(*)

Единственным выходом как нам тогда казалось было внедрение CI (**почему?** - **Маленькие изменения**) и мы даже нашли способ как заставить CI работать на нас!
В декабре 2017 года, мы сделали CI и если скажу, что наша жизнь после этого сразу пошла в гору, то обману вас.
Не смотря на все усилия CI оказался никому не нужен! Мы не можем выпускать релизы с той же скорость с которой мы можем их тестировать.

А чем дольше мы ждем пока код попадет на продакшен тем больше изменений мы добавляем в релиз что приводит к тому что:

* больше скоуп тестирования
* больше тестов в регрессии
* больше интеграционных проблем

К тому же раз релиз большой то и команда эксплуатации выставит ему больший риск и еще сильнее задержит его
и так по кругу. Как итог нет смысла запускать эту всю машинерию если всех устраивает и старый вариант. 


> CI без CD никому не нужен! Нам нужен CD.

## Вступление
### Что мы хотим
Хотим CD для всех компонентов системы, а не для отдельных проектов и сервисов.
Полностью автоматический процесс от лабов(сотни окружений) до продакшена (десятки окружений).
Наш проект - API платформа, это значит сотни интеграций как внутри, так и снаружи. Также мы ограничены следующими требованиями:
- SLA 99.999%
- Разработчики не допускаются к процессу поставки на PRO
- Разработчики не контролируют процедуру поставки

## Основная часть
### Планирование релизов
- Как быть с зависимостями
- Как понять, что инфраструктура готова и можно деплоить

### Мониторинг
- Post deployment verification
- Как понять, что наш сервис работает

### Rainbow deployment
Rainbow deployment очень похож на Blue/Green, но вместо двух цветов мы можем использовать столько цветов сколько хотим.
Это позволит сделать нашу поставку болеее плавной, а в случае проблем мы затронем меньшее количество пользователей.

### Инструменты
Почему мы откзались от jenkins и перешли на spinnaker?

### CI/CD для CI/CD
Как доставлять инфраструктуру для непрерывной доставки?

## Заключение
### Что получаем?
Такой процесс CD открывает путь к микросервисам и маленьким релизам, что в свою очередь избавляет от огромной регрессии
и flaky тестов. Что повышает качество нашего ПО.

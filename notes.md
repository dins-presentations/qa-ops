# QAOps, или почему тестировщик должен построить CI/CD.
Всем привет меня зовут Дима и я тестировщик. Писать тесты я начал 12 лет назад, сначала Unit тесты, потом performance,
e2e, и т.д. Я обожаю писать тесты и это работает:

Cхема: больше тестов -> меньше багов -> качественней продукт!
Подобная схема была даже описанна в книге "Continuous Delivery" чем больше мы тестируем наш продукт,
тем больше мы уверенны в артефакте который деплоим.
 
Но как же бесит когда ты пытаешься сделать по-настоящему качественный продукт,
а вокруг тебя все постоянно задают вопросы:

"Ты закончил тестирование?"
"Когда релиз?"
"Ну что как зарелизились?"

Если что-то мешает писать больше тестов(делать более качественный продукт), мы стараемся исправить ситуацию.
Мы настраиваем jenkins джобу которая прогоняет тесты, которая деплоит, и шлет нотификации в мессенджеры.
Можно даже настроить триггеры на коммит в репозиторий и назвать это CI/CD, ведь если что-то выглядит как 
CI/CD и крякает как CI/CD то наверное это и есть CI/CD.

Можно даже гордо себя именовать специалистами по обеспечению качества, ведь мы не просто пишем тесты но и настраиваем
CI/CD.

Все было прекрасно, я менял компании, писал тесты, настраивал Jenkins джобы,
пока в один прекрасный момент не пришел в DINS.

Мы разрабатываем облачную систему комуникации, звонки, видеоконференции, командный мессенджер, контакт центр,
Мы даже умеем отправлять MMS и Факсы!
И да наша система построенна на принципах SOA
    
На данный момент у нас более 300 сервисов.
    
Я пришел в команду Platform которая разрабатывает API который предоставляет возможность нашим внутренним и внешним разработчикам,
а так же другим компаниям интегрироваться с нашей системой.
На данный момент платформа насчитывает порядка 70 сервисов, которые разрабатывают 7 команд.
    
Когда я только пришел для api платформы было написано примерно 14 000 е2е тестов, 12 000 Unit тестов
у каждой команды было свое тестовое окружение + выделенные окружения для непрерывной интеграции.
Были написаны Jenkins джобы для запуска регрессии, а сама регрессия запускалась 
паралельно на нескольких машинах и судя по статистике джоб выполнялась за 1-2 часа.

Для меня тогда это выглядело как сказка, ровно до того момента как меня попросили прогнать регрессию.
У меня на это ушло 2 недели, а все потому что мне пришлось сделать следующее:

Во первых мне нужно было подготовить окружение:

- Найти какие версии сервисов нам нужны
- Проверить правильно ли они настроенны
- Задеплоить их

Во вторых нужно было прогнать саму регрессию:

- Проверить правильные ли версии Jenkins Job у нас используются
- Обновить их
- Подготовить данные для тестов
- Запустить p0 тесты
- Починить окружение
- Перепрогнать p0 тесты
- Запустить основную регрессию
- Заретраить ее до позеленения

Т.е. либо

* Тесты и Jenkins джобы это не CI
* CI не работает на больших проектах

Но CI/CD придумали большие компании, для больших проектов. Вообщем грусть печаль тоска и огорчение. 
(Kent Beck Chrysler Comprehensive Compensation System)


Из этого я сделал для себя следующие выводы:
Начиная с опеределенного масштаба
1) Тысячи тестов никак не помогают обеспечить/увеличить качество
2) Триггеры и кнопки в Jenkins для запуска тестов и деплоя тоже не помогают


Так что же тогда такое обеспечение качества?

> Quality Assurance — это процесс или результат формирования требуемых свойств и характеристик продукции
> по мере её создания, а также — поддержание этих характеристик при хранении,
> транспортировании и эксплуатации продукции.
> * Wikipedia

Не так давно я со своим коллегой расказывал как настроить и отмасштабировать процесс непрерывной интеграции,
так чтоб тестировать множество небольших изменений.

[картинка с MSCI]

Ключевой идеей данного подхода было ускорение обратной связи, для того чтоб программисты
и тестировщики захотели им пользоваться.

Но абсолютно неважно насколько хороши ваши тесты, ваш CI, ведь пока вы не задеплоитесь на продакшен,
пока у вас не появятся реальные пользователи, вы не узнаете насколько хорош ваш продукт. 

Поэтому нам важно контролировать качество нашего ПО на каждом этапе жизненного цикла, а не только при разработке!
В Lean мы часто используем мантру «Fail fast, fail often!» что является квинтэссенцией идеи получения обратной связи как можно раньше.

С чего же начинается путь к CD и как обеспечить быструю обратную связь, для компании которая заявляет о доступности в 99.999
и 4 релизах в год?

Все знают что такое 5 девяток?
Это значит что наша система может быть недоступна всего лишь:

5.26 минут в год
26.30 секунд в месяц
6.05 секунд в неделю
864.00 милисекунд в день

и пусть 4 релиза в год не вводят вас в заблуждение, ведь релиз != изменение.
Еще до внедрения CD у нас было более *800* изменений на продакшене в неделю, которые делают люди.
И вся наша автоматизация не должна им мешать. И вся наша автоматизация не должна испортить наши 5 девяток.

Итак что же такое хуяк хуяк и в продакшен для большой компании с точки зрения тестировщика?

Во первых мы должны задеплоить на staging, некое окружение максимально близкое к продакшену

Во вторых мы должны протестировать производительность, отказоустойчивость и интеграцию со всем продуктами компании
Для этого мы деплоим на UAT, HA, PERF, STRESS окружения

И вот тепеь то мы подходим к продакшену, но что такое продакшен?

2(3) континента, 4(6) датацентра(ов) и столько контейнеров сколько скажет команда разаботки.

[Когда мы деплоим?]
Как бы вы отреагировали если бы во время регрессии кто-то начал обновлять окружение?
А если кто-то обновит его до начала регрессии и вас не предупредят?
А что будет если кто-то начнет обслуживать инфраструктуру пока вы гоняете регрессию, ну там сеть вырубят?

Я бы огорчился...

А при деплое на продакшен еще больше проблем. 

Вот что вы думаете о деплое в пятницу вечером?
Однажды со мной приключилась одна неприятная истороия, я готовил очень важную фичу всю пятницу.
И вот к вечеру я ее дотестировал и задеплоил на staging. После этого программист ушел домой, 
он жил в подмосковье и добирался на электричке. После всех проверок на staging пришла пора и продакшена...
Размуеется все как в лучших традициях жанра:
* деплоймент джоба зависла
* продакшен упал

У меня нет прав на продакшен сервере, единственный человек с правами сидит в электриччке и тоже без возможности
подключится и помочь мне. Через пол часа должен начаться пик тайм использования нашего сервиса, а ситуация безвыходная.

При этом подобная ситуация могла произойти абсолютно в любой день и запрет на деплой в птяницу 
никак не поможет избежать этой ситуации.

    * You should be confident in your deploys
    * You lose 20% of your productivity without deploying on Friday
    * You just need more tests

Однако если у вас есть внешние обязательства по информированию об изменениях вы не можете деплоить когда вам захочется
Вы так же не можете производить несколько изменений на 1 сервере или "зависимых" серверах одновременно
и никакой DevOps тут не поможет. Начиная с определенного масштаба вам необходимо планировать изменения!

Так же у каждого окружения могут быть свои правила по тому когда можно деплоить а когда нельзя.

1) Мы должны декларативно описывать состояние которое необходимо достичь 
    * никто не захочет описывать как достичь этого состояния и зачастую это невозможно - планы постоянно меняются
2) Пример Delivery Plan (без стратегии деплоя) и интеграции с change management и зависимостями

[у каждого окружения свои правила]

[Как быть с зависимостями]

[что деплоим]
Помимо количества контейнеров и самих контейнеров команда разработки так же может менять
* конфигурацию сервисов
* ресурсы контейнера CPU, Memory, Storage
* Load Balancer'ы

Те на выходе CI мы должны получать артефакт который содержит в себе:
* Docker Image
* Configuration
* Resources
* Balancer's
Что то еще?
* Monitoring

Для того чтоб это все хранить отлично подходит Helm.
[Что такое helm]

Как мы деплоим?
[Deployment Strategies]
[https://harness.io/2018/02/deployment-strategies-continuous-delivery/]
[Rainbow Deployment]


Как мы проверяем что мы задеплоили?



## Вступление
### Что мы хотим
Хотим CD для всех компонентов системы, а не для отдельных проектов и сервисов.
Полностью автоматический процесс от лабов(сотни окружений) до продакшена (десятки окружений).
Наш проект - API платформа, это значит сотни интеграций как внутри, так и снаружи. Также мы ограничены следующими требованиями:
- SLA 99.999%
- Разработчики не допускаются к процессу поставки на PRO
- Разработчики не контролируют процедуру поставки

## Основная часть
### Планирование релизов
- Как быть с зависимостями
- Как понять, что инфраструктура готова и можно деплоить

### Мониторинг
- Post deployment verification
- Как понять, что наш сервис работает

### Rainbow deployment
Rainbow deployment очень похож на Blue/Green, но вместо двух цветов мы можем использовать столько цветов сколько хотим.
Это позволит сделать нашу поставку болеее плавной, а в случае проблем мы затронем меньшее количество пользователей.

### Инструменты
Почему мы откзались от jenkins и перешли на spinnaker?

### CI/CD для CI/CD
Как доставлять инфраструктуру для непрерывной доставки?

## Заключение
### Что получаем?
Такой процесс CD открывает путь к микросервисам и маленьким релизам, что в свою очередь избавляет от огромной регрессии
и flaky тестов. Что повышает качество нашего ПО.

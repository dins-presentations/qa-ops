# QAOps, или почему тестировщик должен построить CI/CD.
Всем привет меня зовут Дима и я тестировщик. Писать тесты я начал 12 лет назад, сначала Unit тесты, потом 
performance, e2e, и т.д. Почти все время я оправдывал свое желание писать тесты заботой о качестве продукта.
Эта схема работала: больше тестов -> меньше багов -> качественней продукт!

Все было прекрасно, я менял компании, писал тесты, тестовые фреймворки, настраивал Jenkins джобы,
пока в один прекрасный момент не пришел в DINS.

Мы разрабатываем облачную систему комуникации, звонки видеоконференции командный мессенджер контакт центр,
Мы даже умеем отправлять MMS и Факсы!
И да наша система построенна на принципах SOA
    
На данный момент у нас более 300 сервисов.
    
Я пришел в команду Platform которая разрабатывает API который предоставляет возможность нашим внутренним и внешним разработчикам,
а так же другим компаниям интегрироваться с нашей системой.
На данный момент платформа насчитывает порядка 70 сервисов, которые разрабатывают 7 команд.
    
Когда я только пришел для api платформы было написано примерно 14 000 е2е тестов, 12 000 Unit тестов
у каждой команды было свое тестовое окружение + выделенные окружения для непрерывной интеграции.
Были написаны Jenkins джобы для запуска регрессии, а сама регрессия запускалась 
паралельно на нескольких машинах и судя по статистике джоб выполнялась за 1-2 часа.

Для меня тогда это выглядело как сказка, ровно до того момента как меня попросили прогнать регрессию.
У меня на это ушло 2 недели, а все потому что мне пришлось сделать следующее:

Во первых мне нужно было подготовить окружение:

- Найти какие версии сервисов нам нужны
- Проверить правильно ли они настроенны
- Задеплоить их

Во вторых нужно было прогнать саму регрессию:

- Проверить правильные ли версии Jenkins Job у нас используются
- Обновить их
- Подготовить данные для тестов
- Запустить p0 тесты
- Починить окружение
- Перепрогнать p0 тесты
- Запустить основную регрессию
- Заретраить ее до позеленения

Из всего этого я сделал для себя следующие выводы:
Начиная с опеределенного масштаба
1) Тысячи тестов никак не помогают обеспечить/увеличить качество
2) Кнопки в Jenkins для запуска тестов и деплоя тоже не помогают

И даже больше, они вызывают грусть тоску печаль и огорчение.
[нажать 100500 кнопок]

Так что же тогда такое обеспечение качества?

> Quality Assurance — это процесс или результат формирования требуемых свойств и характеристик продукции
> по мере её создания, а также — поддержание этих характеристик при хранении,
> транспортировании и эксплуатации продукции.
> * Wikipedia

Не так давно я со своим коллегой расказывал как настроить и отмасштабировать процесс непрерывной интеграции,
так чтоб тестировать множество небольших изменений.

[картинка с MSCI]

Ключевой идеей данного подхода было ускорение обратной связи, для того чтоб программисты
и тестировщики захотели им пользоваться.

Но абсолютно неважно насколько хороши ваши тесты, ваш CI, ведь пока вы не задеплоитесь на продакшен,
пока у вас не появятся реальные пользователи, вы не узнаете насколько хорош ваш продукт. 

Поэтому нам важно котролировать качество нашего ПО на каждом этапе жизненного цикла, а не только при разработке!
В Lean мы часто используем мантру «Fail fast, fail often!» что является квинтэссенцией идеи получения обратной связи как можно раньше.

С чего же начинается путь к CD и как обеспечить быструю обратную связь?


> куда деплоим?
> ops - stage
> uat, ha, perf, stress - verify
> sjc, iad, ams, zhr (еще 2 локации) - prod


Для начала нужно понять что можно считать деплоймент пакетом?
1) Код
2) Конфигурация
3) Resources (Disk, CPU, Memory, Instances)?
4) Мониторинг
5) Service Discovery

Для того чтоб это все хранить отлично подходит Helm.
[Что такое helm]

Куда мы деплоим?
[Окружения и путь до продакшена]

Когда мы деплоим?
[у каждого окружения свои правила]
[Как быть с зависимостями]
[Release and change management]

Как мы деплоим?
[Deployment Strategies]
[https://harness.io/2018/02/deployment-strategies-continuous-delivery/]
[Rainbow Deployment]


Как мы проверяем что мы задеплоили?


> SRE Tools, >800 cmr's/week 2019 ( ~200 cmr's/week 2014) 
> Большинство сбоев связанно с изменениями
> ITIL - 1989 год британия -> разработка британских ученых
> свод требований для поставщиков IT услуг
> ITIL v3 - 4 толстых книги
> Change/Incident/Release management
> Нужно спланировать - 
> Почему нельзя сразу на продакшен: 
> 1) MW - пока все спят
> 2) Партнеры - мы обязанны уведомить партнеров об изменениях заранее
> 3) Нельзя делать работы на одном сервере (2 инженера на 1 сервере)
> 4) Нельзя изменения вносить сразу во все локейшены
> 5) Последовательность (зависимости)
> 6) Собрать всех участников изменений - ?
>
> https://status.ringcentral.com/
> мобильное приложение для IMP/CMP/JIRA
>
>


## Вступление
### Что мы хотим
Хотим CD для всех компонентов системы, а не для отдельных проектов и сервисов.
Полностью автоматический процесс от лабов(сотни окружений) до продакшена (десятки окружений).
Наш проект - API платформа, это значит сотни интеграций как внутри, так и снаружи. Также мы ограничены следующими требованиями:
- SLA 99.999%
- Разработчики не допускаются к процессу поставки на PRO
- Разработчики не контролируют процедуру поставки

## Основная часть
### Планирование релизов
- Как быть с зависимостями
- Как понять, что инфраструктура готова и можно деплоить

### Мониторинг
- Post deployment verification
- Как понять, что наш сервис работает

### Rainbow deployment
Rainbow deployment очень похож на Blue/Green, но вместо двух цветов мы можем использовать столько цветов сколько хотим.
Это позволит сделать нашу поставку болеее плавной, а в случае проблем мы затронем меньшее количество пользователей.

### Инструменты
Почему мы откзались от jenkins и перешли на spinnaker?

### CI/CD для CI/CD
Как доставлять инфраструктуру для непрерывной доставки?

## Заключение
### Что получаем?
Такой процесс CD открывает путь к микросервисам и маленьким релизам, что в свою очередь избавляет от огромной регрессии
и flaky тестов. Что повышает качество нашего ПО.

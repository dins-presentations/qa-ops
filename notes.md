# QAOps, или почему тестировщик должен построить CI/CD.
Всем привет меня зовут Дима и я тестировщик. Писать тесты я начал 12 лет назад, сначала Unit тесты, потом 
performance, e2e, и т.д. Почти все время я оправдывал свое желание писать тесты заботой о качестве продукта.
Эта схема работала: больше тестов -> меньше багов -> качественней продукт!

Все было прекрасно, я менял компании, писал тесты, тестовые фреймворки, настраивал Jenkins джобы
пока в один прекрасный момент не пришел в DINS.

    [о компании?]
    Мы разрабатываем облачную систему комуникации, звонки видеоконференции командный мессенджер контакт центр,
    Мы даже умеем отправлять MMS и Факсы!
    И да наша система построенна на принципах SOA
    
    На данный момент у нас более 300 сервисов.
    
    API платформа предоставляет возможность нашим внутренним и внешним разработчикам а так же другим компаниям интегрироваться с нашей системой.
    На данный момент платформа насчитывает порядка 70 сервисов, которые разрабатывают 60 человек (7 команд).
    
Когда я только пришел для api платформы было написано 14 000 е2е тестов, 12 000 Unit тестов у каждой команды было свое 
тестовое окружение + выделенные окружения для непрерывной интеграции.
Были написаны Jenkins джобы для запуска регрессии, а сама регрессия запускалась 
паралельно на нескольких машинах.

    [Jenkins Job isn't CI]

Для меня тогда это выглядело как сказка, ровно до того момента как меня попросили прогнать регрессию:

Во первых мне нужно было подготовить окружение:

- Найти какие версии сервисов нам нужны
- Проверить правильно ли они настроенны
- Задеплоить их

Во вторых нужно было прогнать саму регрессию:

- Проверить правильные ли версии Jenkins Job у нас используются
- Обновить их
- Подготовить данные для тестов
- Запустить p0 тесты
- Починить окружение
- Перепрогнать p0 тесты
- Запустить основную регрессию
- Заретраить ее до позеленения

Так я быстро понял откуда пошло правило: "Тест который не упал 3 раза не считается упавшим"

А что если в итоге упадет даже 1-2% тестов, разобрать 360 тестов не так то и просто, как следствие регрессия занимает 2-3 дня!
Так же не следует забывать что готовить окружение для регрессии можно неделями!

> О каком качестве можно говорить если мы ретраим?
> О каком качестве можно говорить если регрессия никогда не бывает зеленой?
> Как добавление еще нескольких тысяч тестов повысит качество?

Если тысячи тестов и Jenkins джобы это все не про качество то что такое обеспечение качеста?

> Quality Assurance — это процесс или результат формирования требуемых свойств и характеристик продукции
> по мере её создания, а также — поддержание этих характеристик при хранении,
> транспортировании и эксплуатации продукции.
> * Wikipedia

Не так давно я со своим коллегой расказывал как настроить и отмасштабировать процесс непрерывной интеграции,
так чтоб тестировать множество небольших изменений, но работать с небольшими изменениями 
любят не только разработчики и тестировщики. Команда эксплуатации тоже любит 
небольшие изменения, ведь чем меньше изменение тем меньше риск! 

Но без автоматизации, все эти изменения будут собираться в группы/пакеты(bundle).

Принципы Lean гласят, что маленькие изменения лучше, всегда лучше, и чем меньше, тем лучше.
Это снижает риски и сокращает обратную связь.
    
    [Почему фидбек важен?]

С чего же начинается путь к CD? Обычно под CI/CD понимают пайплайн:

Build -> Test -> Deploy 

Для начала нужно понять что мы деплоим?
1) Код
2) Конфигурация


    [Helm]

Куда мы деплоим?

Когда мы деплоим?

Как мы проверяем что мы задеплоили?

## Вступление
### Что мы хотим
Хотим CD для всех компонентов системы, а не для отдельных проектов и сервисов.
Полностью автоматический процесс от лабов(сотни окружений) до продакшена (десятки окружений).
Наш проект - API платформа, это значит сотни интеграций как внутри, так и снаружи. Также мы ограничены следующими требованиями:
- SLA 99.999%
- Разработчики не допускаются к процессу поставки на PRO
- Разработчики не контролируют процедуру поставки

## Основная часть
### Планирование релизов
- Как быть с зависимостями
- Как понять, что инфраструктура готова и можно деплоить

### Мониторинг
- Post deployment verification
- Как понять, что наш сервис работает

### Rainbow deployment
Rainbow deployment очень похож на Blue/Green, но вместо двух цветов мы можем использовать столько цветов сколько хотим.
Это позволит сделать нашу поставку болеее плавной, а в случае проблем мы затронем меньшее количество пользователей.

### Инструменты
Почему мы откзались от jenkins и перешли на spinnaker?

### CI/CD для CI/CD
Как доставлять инфраструктуру для непрерывной доставки?

## Заключение
### Что получаем?
Такой процесс CD открывает путь к микросервисам и маленьким релизам, что в свою очередь избавляет от огромной регрессии
и flaky тестов. Что повышает качество нашего ПО.

# QAOps, или почему тестировщик должен построить CI/CD.
Всем привет меня зовут Дима и я тестировщик. Писать тесты я начал 12 лет назад, сначала Unit тесты, потом 
performance, e2e, и т.д. Почти все время я оправдывал свое желание писать тесты заботой о качестве продукта.
Эта схема работала: больше тестов -> меньше багов -> качественней продукт!

Все было прекрасно, я менял компании, писал тесты, тестовые фреймворки, настраивал Jenkins джобы,
пока в один прекрасный момент не пришел в DINS.

Мы разрабатываем облачную систему комуникации, звонки видеоконференции командный мессенджер контакт центр,
Мы даже умеем отправлять MMS и Факсы!
И да наша система построенна на принципах SOA
    
На данный момент у нас более 300 сервисов.
    
Я пришел в команду Platform которая разрабатывает API который предоставляет возможность нашим внутренним и внешним разработчикам,
а так же другим компаниям интегрироваться с нашей системой.
На данный момент платформа насчитывает порядка 70 сервисов, которые разрабатывают 7 команд.
    
Когда я только пришел для api платформы было написано примерно 14 000 е2е тестов, 12 000 Unit тестов
у каждой команды было свое тестовое окружение + выделенные окружения для непрерывной интеграции.
Были написаны Jenkins джобы для запуска регрессии, а сама регрессия запускалась 
паралельно на нескольких машинах и судя по статистике джоб выполнялась за 1-2 часа.

Для меня тогда это выглядело как сказка, ровно до того момента как меня попросили прогнать регрессию.
У меня на это ушло 2 недели, а все потому что мне пришлось сделать следующее:

Во первых мне нужно было подготовить окружение:

- Найти какие версии сервисов нам нужны
- Проверить правильно ли они настроенны
- Задеплоить их

Во вторых нужно было прогнать саму регрессию:

- Проверить правильные ли версии Jenkins Job у нас используются
- Обновить их
- Подготовить данные для тестов
- Запустить p0 тесты
- Починить окружение
- Перепрогнать p0 тесты
- Запустить основную регрессию
- Заретраить ее до позеленения

Из всего этого я сделал для себя следующие выводы:
1) Тысячи тестов никак не помогают обеспечить/увеличить качество
2) Кнопки в Jenkins для запуска тестов и деплоя тоже не помогают

А при определенном масштабе могут еще и вызывать грусть тоску печаль и огорчение.

Так что же тогда такое обеспечение качества?

> Quality Assurance — это процесс или результат формирования требуемых свойств и характеристик продукции
> по мере её создания, а также — поддержание этих характеристик при хранении,
> транспортировании и эксплуатации продукции.
> * Wikipedia

Не так давно я со своим коллегой расказывал как настроить и отмасштабировать процесс непрерывной интеграции,
так чтоб тестировать множество небольших изменений.

[картинка с MSCI]

Feedback Loop

[Неважно насколько вы хорошо протестируете если вы неправильно написали инструкцию по деплойменту!]
[Писать инструкции скучно!]


Но без автоматизации, все эти изменения будут собираться в группы/пакеты(bundle).

Принципы Lean гласят, что маленькие изменения лучше, всегда лучше, и чем меньше, тем лучше.
Это снижает риски и сокращает обратную связь.
    
    [Почему фидбек важен?]

С чего же начинается путь к CD? Обычно под CI/CD понимают пайплайн:

Build -> Test -> Deploy 

Для начала нужно понять что мы деплоим?
1) Код
2) Конфигурация


    [Helm]

Куда мы деплоим?

Когда мы деплоим?

Как мы проверяем что мы задеплоили?

## Вступление
### Что мы хотим
Хотим CD для всех компонентов системы, а не для отдельных проектов и сервисов.
Полностью автоматический процесс от лабов(сотни окружений) до продакшена (десятки окружений).
Наш проект - API платформа, это значит сотни интеграций как внутри, так и снаружи. Также мы ограничены следующими требованиями:
- SLA 99.999%
- Разработчики не допускаются к процессу поставки на PRO
- Разработчики не контролируют процедуру поставки

## Основная часть
### Планирование релизов
- Как быть с зависимостями
- Как понять, что инфраструктура готова и можно деплоить

### Мониторинг
- Post deployment verification
- Как понять, что наш сервис работает

### Rainbow deployment
Rainbow deployment очень похож на Blue/Green, но вместо двух цветов мы можем использовать столько цветов сколько хотим.
Это позволит сделать нашу поставку болеее плавной, а в случае проблем мы затронем меньшее количество пользователей.

### Инструменты
Почему мы откзались от jenkins и перешли на spinnaker?

### CI/CD для CI/CD
Как доставлять инфраструктуру для непрерывной доставки?

## Заключение
### Что получаем?
Такой процесс CD открывает путь к микросервисам и маленьким релизам, что в свою очередь избавляет от огромной регрессии
и flaky тестов. Что повышает качество нашего ПО.
